#!/bin/bash
#
# This is a shell script for managing
# LCMP (Linux + Caddy + MariaDB + PHP) environment
#
# Supported OS:
#   - Enterprise Linux 8/9/10 (CentOS Stream, RHEL, Rocky Linux, AlmaLinux, Oracle Linux)
#   - Debian 11/12/13
#   - Ubuntu 20.04/22.04/24.04
#
# Copyright (C) 2023 - 2026 Teddysun <i@teddysun.com>
set -uo pipefail
shopt -s inherit_errexit 2>/dev/null || true
trap _exit INT QUIT TERM

_red() {
    printf '\033[1;31;31m%b\033[0m' "$1"
}

_green() {
    printf '\033[1;31;32m%b\033[0m' "$1"
}

_yellow() {
    printf '\033[1;31;33m%b\033[0m' "$1"
}

_printargs() {
    printf -- "%s" "[$(date)] "
    printf -- "%s" "$1"
    printf "\n"
}

_info() {
    _printargs "$@"
}

_warn() {
    printf -- "%s" "[$(date)] "
    _yellow "$1"
    printf "\n"
}

_error() {
    printf -- "%s" "[$(date)] "
    _red "$1"
    printf "\n"
    exit 2
}

_exit() {
    printf "\n"
    _red "$0 has been terminated."
    printf "\n"
    exit 1
}

# Check if a command exists
_exists() {
    command -v "$1" &>/dev/null
}

_error_detect() {
    local cmd="$1"
    _info "${cmd}"
    if ! eval "${cmd}" 1>/dev/null; then
        _error "Executing command (${cmd}) failed, please check it and try again."
    fi
}

_sleep_sec() {
    seconds=$1
    while [[ "${seconds}" -ge "0" ]]; do
      echo -ne "\r     \r"
      _green "${seconds}"
      seconds=$((seconds - 1))
      sleep 1
    done
    echo -ne "\r"
}

# Get OS ID from /etc/os-release
_get_os_id() {
    if [[ -f /etc/os-release ]]; then
        awk -F= '/^ID=/{gsub(/"/, ""); print $2}' /etc/os-release
    fi
}

# Check OS type
_check_sys() {
    local os_type="$1"
    local os_id
    os_id=$(_get_os_id)
    case "${os_type}" in
        rhel)
            [[ "${os_id}" =~ ^(centos|rhel|rocky|almalinux|ol|fedora)$ ]] || \
            [[ -f /etc/redhat-release ]]
            ;;
        debian)
            [[ "${os_id}" == "debian" ]]
            ;;
        ubuntu)
            [[ "${os_id}" == "ubuntu" ]]
            ;;
        *)
            return 1
            ;;
    esac
}

#==============================================================================
# Input Validation Helper
#==============================================================================

_validate_input() {
    local input="$1"
    local name="$2"
    local pattern="${3:-}"
    local check_exists="${4:-}"
    local exists_path="${5:-}"
    
    if [[ -z "${input}" ]]; then
        _red "${name} can not be empty.\n"
        return 1
    fi
    if [[ "${input}" =~ [[:space:]] ]]; then
        _red "${name} can not contain space.\n"
        return 1
    fi
    if [[ -n "${pattern}" && ! "${input}" =~ ${pattern} ]]; then
        _red "${name} is invalid.\n"
        return 1
    fi
    if [[ "${check_exists}" == "file" && -f "${exists_path}${input}.conf" ]]; then
        _red "${name} ${input} already exists.\n"
        return 1
    fi
    return 0
}

_read_validated() {
    local prompt="$1"
    local name="$2"
    local pattern="${3:-}"
    local check_exists="${4:-}"
    local exists_path="${5:-}"
    local var_name="$6"
    local is_secret="${7:-}"
    local default_value="${8:-}"
    
    local input
    while true; do
        if [[ "${is_secret}" == "secret" ]]; then
            read -s -r -p "${prompt}" input
            echo
        else
            read -r -p "${prompt}" input
        fi
        
        # If the input is empty and a default value exists, use the default value.
        if [[ -z "${input}" && -n "${default_value}" ]]; then
            printf -v "${var_name}" '%s' "${default_value}"
            return 0
        fi
        
        if _validate_input "${input}" "${name}" "${pattern}" "${check_exists}" "${exists_path}"; then
            printf -v "${var_name}" '%s' "${input}"
            return 0
        fi
    done
}

#==============================================================================
# Command Routing with Case-Insensitive Matching
#==============================================================================

vhost() {
    case "$(echo "$1" | tr '[:upper:]' '[:lower:]')" in
        add)
            add_vhost
            ;;
        list)
            list_vhost
            ;;
        del)
            del_vhost
            ;;
        *)
            _error "Usage: lcmp vhost [add|list|del]"
            ;;
    esac
}

database() {
    case "$(echo "$1" | tr '[:upper:]' '[:lower:]')" in
        add)
            add_database_menu
            add_database
            ;;
        list)
            list_database
            ;;
        del)
            del_database
            ;;
        edit)
            edit_database
            ;;
        *)
            _error "Usage: lcmp db [add|list|del|edit]"
            ;;
    esac
}

#==============================================================================
# Virtual Host Management
#==============================================================================

add_vhost() {
    # Domain input with validation
    local domain
    _read_validated \
        "[$(date)] Please input a domain (example: www.lamp.sh): " \
        "Domain name" \
        '^[a-zA-Z0-9][-a-zA-Z0-9.]*[a-zA-Z0-9]$' \
        "file" \
        "/etc/caddy/conf.d/" \
        "domain"
    
    _info "Domain name: $(_green "${domain}")"

    # Check if domain is a root domain (format: domain.tld, only one dot)
    local redirect_www="n"
    local www_domain=""
    if [[ "${domain}" != *.*.* ]] && [[ "${domain}" == *.* ]]; then
        www_domain="www.${domain}"
        if [[ ! -f "/etc/caddy/conf.d/${www_domain}.conf" ]]; then
            local choice
            read -r -p "[$(date)] Redirect $(_green "${domain}") to $(_green "${www_domain}") (y/n, default: n): " choice
            if [[ "${choice}" =~ ^[Yy]$ ]]; then
                redirect_www="y"
                _info "Will redirect $(_green "${domain}") to $(_green "${www_domain}")"
            fi
        fi
    fi

    # Virtual Host directory input
    local vhostdir
    _read_validated \
        "[$(date)] Please input a directory for domain ${domain} (default: /data/www/${domain}): " \
        "Directory" \
        '^/' \
        "" "" \
        "vhostdir" \
        "" \
        "/data/www/${domain}"
    
    _info "Virtual Host directory: $(_green "${vhostdir}")"

    # Database creation option
    local create_database
    read -r -p "[$(date)] Create a MariaDB database and a user with same name (y/n): " create_database
    if [[ "${create_database}" =~ ^[Yy]$ ]]; then
        verify_db_password
        add_database_menu
    fi
    
    # Create directories and permissions
    _info "Create Virtual Host directory"
    _error_detect "mkdir -p ${vhostdir}"
    _info "Set permissions of Virtual Host directory"
    _error_detect "chmod -R 755 ${vhostdir}"
    _error_detect "chown -R caddy:caddy ${vhostdir}"
    
    # Generate config
    add_vhost_config "${domain}" "${www_domain}" "${redirect_www}" "${vhostdir}"
    
    if [[ "${create_database}" =~ ^[Yy]$ ]]; then
        add_database
    fi
    
    _error_detect "systemctl restart caddy"
    
    # Output summary
    _info "Virtual Host information:"
    _info "Domain name: $(_green "${domain}")"
    if [[ "${redirect_www}" == "y" ]]; then
        _info "Redirect: $(_green "${domain}") -> $(_green "${www_domain}")"
    fi
    _info "Virtual Host directory: $(_green "${vhostdir}")"
    _info "Virtual Host config: $(_green "/etc/caddy/conf.d/${domain}.conf")"
    list_vhost
    if [[ "${create_database}" =~ ^[Yy]$ ]]; then
        _info "Database username: ${database_name}"
        _info "Database userpassword: ${mysql_password}"
        _info "Database name: ${database_name}"
    fi
}

add_vhost_config() {
    local domain="$1"
    local www_domain="$2"
    local redirect_www="$3"
    local vhostdir="$4"
    
    local domains="${domain}"
    local redirect_block=""
    
    if [[ "${redirect_www}" == "y" ]]; then
        domains="${domain}, ${www_domain}"
        redirect_block=$'    @www host '"${domain}"$'\n    redir @www https://'"${www_domain}"$'{uri} permanent\n'
    fi
    
    cat >"/etc/caddy/conf.d/${domain}.conf" <<EOF
${domains} {
    header {
        Strict-Transport-Security "max-age=31536000; preload"
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
    }
${redirect_block}    root * ${vhostdir}
    encode gzip zstd
    php_fastcgi ${php_sock}
    file_server {
        index index.html
    }
    log {
        output file /var/log/caddy/access_${domain}.log {
            roll_size 32mb
            roll_keep 3
            roll_keep_for 7d
        }
    }
}
EOF
}

list_vhost() {
    _info "Caddy Virtual Host list:"
    local vhosts=()
    while IFS=' ' read -r line; do vhosts+=("${line}"); done < <(find /etc/caddy/conf.d/ -name "*.conf" -type f -printf "%f\n" | sed 's/.conf//g' | grep -v "default")
    if [[ "${#vhosts[@]}" -gt 0 ]]; then
        for i in "${vhosts[@]}"; do
            _info "  $(_green "${i}")"
        done
    else
        _info "Caddy Virtual Host not found. You can create a new Caddy Virtual Host with command: $(_green "lcmp vhost add")"
    fi
}

del_vhost() {
    local vhostdir
    list_vhost
    
    local domain
    _read_validated \
        "[$(date)] Please enter a domain you want to delete: " \
        "Domain name" \
        '^[a-zA-Z0-9][-a-zA-Z0-9.]*[a-zA-Z0-9]$' \
        "" "" \
        "domain"
    
    _info "Domain name: $(_green "${domain}")"
    
    if [[ -f "/etc/caddy/conf.d/${domain}.conf" ]]; then
        vhostdir=$(grep "root \*" "/etc/caddy/conf.d/${domain}.conf" | awk '{print $3}')
        _error_detect "rm -f /etc/caddy/conf.d/${domain}.conf"
        _info "Domain $(_red "${domain}") has been deleted."
        if [[ -n "${vhostdir}" ]]; then
            _info "Website directory $(_red "${vhostdir}") will not be deleted for security reasons."
        else
            _info "Website directory will not be deleted for security reasons."
        fi
        _info "You need to manually delete the website files."
        systemctl restart caddy >/dev/null 2>&1
    else
        _error "Domain: ${domain} does not exist."
    fi
}

#==============================================================================
# Database Helpers
#==============================================================================

make_temp_mycnf() {
    cat >/tmp/.my.cnf<<EOF
[client]
user=root
password='$1'
EOF
    chmod 600 /tmp/.my.cnf
}

clean_temp_mycnf() {
    [[ -s "/tmp/.my.cnf" ]] && rm -f /tmp/.my.cnf
    [[ -s "/tmp/.mysql.tmp" ]] && rm -f /tmp/.mysql.tmp
}

do_query() {
    echo "$1" >/tmp/.mysql.tmp
    chmod 600 /tmp/.mysql.tmp
    /usr/bin/mariadb --defaults-file=/tmp/.my.cnf </tmp/.mysql.tmp
    return $?
}

run_sql() {
    local sql_content="$1"
    local success_msg="$2"
    local fail_msg="$3"
    
    local tmpfile
    tmpfile=$(mktemp /tmp/.lcmp.XXXXXX.sql)
    echo "${sql_content}" > "${tmpfile}"
    chmod 600 "${tmpfile}"
    
    if /usr/bin/mariadb --defaults-file=/tmp/.my.cnf < "${tmpfile}" >/dev/null 2>&1; then
        _info "${success_msg}"
    else
        _info "${fail_msg}"
    fi
    rm -f "${tmpfile}"
}

verify_db_password() {
    local status=1
    while [[ ${status} -eq 1 ]]; do
        local db_root_password
        read -s -r -p "[$(date)] Please input current root password of Database (password will not shown): " db_root_password
        echo
        if ! /usr/bin/mariadb -uroot -p"${db_root_password}" -e "exit" >/dev/null 2>&1; then
            _red "MariaDB root password is incorrect, Please check it and try again.\n"
            continue
        fi
        make_temp_mycnf "${db_root_password}"
        do_query "exit"
        status=$?
    done
}

enter_database_name() {
    _read_validated \
        "[$(date)] Please input database name: " \
        "Database name" \
        "" "" "" \
        "database_name"
}

add_database_menu() {
    enter_database_name
    _info "You will create a MariaDB database and a user with same name: $(_green "${database_name}")"
    
    local password_input
    read -s -r -p "[$(date)] Please input password for MariaDB user ${database_name} (password will not shown): " password_input
    mysql_password="${password_input:-${database_name}}"
    echo
    _info "MariaDB database $(_green "${database_name}")'s password: ${mysql_password}"
}

add_database() {
    local sql_content
    sql_content=$(cat <<EOF
CREATE USER '${database_name}'@'localhost' IDENTIFIED BY '${mysql_password}';
CREATE USER '${database_name}'@'127.0.0.1' IDENTIFIED BY '${mysql_password}';
GRANT USAGE ON *.* TO '${database_name}'@'localhost' IDENTIFIED BY '${mysql_password}';
GRANT USAGE ON *.* TO '${database_name}'@'127.0.0.1' IDENTIFIED BY '${mysql_password}';
CREATE DATABASE IF NOT EXISTS \`${database_name}\`;
GRANT ALL PRIVILEGES ON \`${database_name}\`.* TO '${database_name}'@'localhost';
GRANT ALL PRIVILEGES ON \`${database_name}\`.* TO '${database_name}'@'127.0.0.1';
FLUSH PRIVILEGES;
EOF
)
    run_sql "${sql_content}" \
        "Add database $(_green "${database_name}") successfully." \
        "Add database $(_red "${database_name}") failed."
}

list_database() {
    if /usr/bin/mariadb --defaults-file=/tmp/.my.cnf -e "SHOW DATABASES;"; then
        _info "List all databases successfully."
    else
        _info "List all databases failed."
    fi
}

del_database() {
    list_database
    enter_database_name
    
    if [[ "${database_name}" =~ ^(information_schema|mysql|performance_schema|sys)$ ]]; then
        _error "MariaDB system database $(_red "${database_name}") cannot be deleted."
    fi
    
    _info "Your will delete a MariaDB database and a user with same name: ${database_name}"
    _info "Wait 10 seconds, Press ctrl+c to cancel ..."
    _sleep_sec 10
    
    local sql_content
    sql_content=$(cat <<EOF
DROP USER '${database_name}'@'127.0.0.1';
DROP USER '${database_name}'@'localhost';
DROP DATABASE IF EXISTS \`${database_name}\`;
FLUSH PRIVILEGES;
EOF
)
    run_sql "${sql_content}" \
        "Delete database $(_green "${database_name}") successfully." \
        "Delete database $(_red "${database_name}") failed."
}

edit_database() {
    local database_username
    _read_validated \
        "[$(date)] Please input database username: " \
        "Database username" \
        "" "" "" \
        "database_username"
    
    local database_username_passwd
    _read_validated \
        "[$(date)] Please input NEW password (password will not shown): " \
        "NEW password" \
        "" "" "" \
        "database_username_passwd" \
        "secret"
    
    local sql_content
    sql_content=$(cat <<EOF
SET PASSWORD FOR '${database_username}'@'127.0.0.1' = PASSWORD('${database_username_passwd}');
SET PASSWORD FOR '${database_username}'@'localhost' = PASSWORD('${database_username_passwd}');
FLUSH PRIVILEGES;
EOF
)
    run_sql "${sql_content}" \
        "Edit user $(_green "${database_username}")'s password successfully." \
        "Edit user $(_red "${database_username}")'s password failed."
}

#==============================================================================
# Service Management
#==============================================================================

manage_services() {
    local action="$1"  # start, stop, status
    local label="$2"   # Starting, Stopping, Checking
    
    _info "${label} LCMP..."
    local services=("caddy" "mariadb" "${php_fpm}")
    
    for svc in "${services[@]}"; do
        case "${action}" in
            start)
                _error_detect "systemctl start ${svc}"
                ;;
            stop)
                _error_detect "systemctl stop ${svc}"
                ;;
            status)
                _info "systemctl status ${svc}"
                systemctl --no-pager -l status "${svc}" || true
                echo
                ;;
        esac
    done
    
    [[ "${action}" != "status" ]] && _info "${label} LCMP completed"
}

lcmp_start() {
    manage_services "start" "Starting"
}

lcmp_stop() {
    manage_services "stop" "Stopping"
}

lcmp_restart() {
    manage_services "stop" "Stopping"
    sleep 1
    manage_services "start" "Starting"
}

lcmp_status() {
    manage_services "status" "Checking"
}

lcmp_version() {
    _info "$(_green "Caddy") version:"
    [[ -x "/usr/bin/caddy" ]] && /usr/bin/caddy version || true
    echo
    _info "$(_green "MariaDB") version:"
    [[ -x "/usr/bin/mariadb" ]] && /usr/bin/mariadb --version || true
    echo
    _info "$(_green "PHP") version:"
    [[ -x "/usr/bin/php" ]] && /usr/bin/php -v || true
}

check_env() {
    if _check_sys rhel; then
        php_sock="unix//run/php-fpm/www.sock"
        php_fpm="php-fpm"
    elif _check_sys debian || _check_sys ubuntu; then
        php_sock="unix//run/php/php-fpm.sock"
        local php_ver
        php_ver="$(/usr/bin/php -v | head -n1 | awk '{print $2}' | cut -d. -f1-2)"
        php_fpm="php${php_ver}-fpm"
    else
        _error "Unsupported OS. Please use Enterprise Linux 8+, Debian 11+, or Ubuntu 20.04+"
    fi
}

#==============================================================================
# Usage Information
#==============================================================================

show_usage() {
    _info "Usage:"
    _info "  $(_green "lcmp start")      Start all LCMP services"
    _info "  $(_green "lcmp stop")       Stop all LCMP services"
    _info "  $(_green "lcmp restart")    Restart all LCMP services"
    _info "  $(_green "lcmp status")     Check all LCMP services status"
    _info "  $(_green "lcmp version")    Print all of LCMP software version"
    _info "  $(_green "lcmp vhost add")  Create a new Caddy Virtual Host"
    _info "  $(_green "lcmp vhost list") List all of Caddy Virtual Hosts"
    _info "  $(_green "lcmp vhost del")  Delete a Caddy Virtual Host"
    _info "  $(_green "lcmp db add")     Create a MariaDB database and a user with same name"
    _info "  $(_green "lcmp db list")    List all of MariaDB databases"
    _info "  $(_green "lcmp db del")     Delete a MariaDB database and a user with same name"
    _info "  $(_green "lcmp db edit")    Update a MariaDB database username's password"
}

#==============================================================================
# Main Entry Point
#==============================================================================

main() {
    # Check root
    if [[ ${EUID} -ne 0 ]]; then
        _red "This script must be run as root!\n"
        exit 1
    fi
    
    local arg1="${1:-}"
    local arg2="${2:-}"

    _info "+-------------------------------------------+"
    _info "|    Manager for LCMP, Written by Teddysun  |"
    _info "+-------------------------------------------+"
    _info "|    $(_green "https://github.com/teddysun/lcmp")       |"
    _info "+-------------------------------------------+"

    check_env

    case "$(echo "${arg1}" | tr '[:upper:]' '[:lower:]')" in
        start)
            lcmp_start
            ;;
        stop)
            lcmp_stop
            ;;
        restart)
            lcmp_restart
            ;;
        status)
            lcmp_status
            ;;
        version)
            lcmp_version
            ;;
        vhost)
            vhost "${arg2}"
            ;;
        db)
            verify_db_password
            database "${arg2}"
            clean_temp_mycnf
            ;;
        *)
            show_usage
            ;;
    esac
}

# Run main function
main "$@"
