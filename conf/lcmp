#!/bin/bash
#
# This is a shell script for managing
# LCMP (Linux + Caddy + MariaDB + PHP) environment
#
# Supported OS:
#   - Enterprise Linux 8/9/10 (CentOS Stream, RHEL, Rocky Linux, AlmaLinux, Oracle Linux)
#   - Debian 11/12/13
#   - Ubuntu 20.04/22.04/24.04
#
# Copyright (C) 2023 - 2026 Teddysun <i@teddysun.com>
set -euo pipefail
shopt -s inherit_errexit 2>/dev/null || true

trap _exit INT QUIT TERM

_red() {
    printf '\033[1;31;31m%b\033[0m' "$1"
}

_green() {
    printf '\033[1;31;32m%b\033[0m' "$1"
}

_yellow() {
    printf '\033[1;31;33m%b\033[0m' "$1"
}

_printargs() {
    printf -- "%s" "[$(date)] "
    printf -- "%s" "$1"
    printf "\n"
}

_info() {
    _printargs "$@"
}

_warn() {
    printf -- "%s" "[$(date)] "
    _yellow "$1"
    printf "\n"
}

_error() {
    printf -- "%s" "[$(date)] "
    _red "$1"
    printf "\n"
    exit 2
}

_exit() {
    printf "\n"
    _red "$0 has been terminated."
    printf "\n"
    exit 1
}

# Check if a command exists
_exists() {
    command -v "$1" &>/dev/null
}

_error_detect() {
    local cmd="$1"
    _info "${cmd}"
    if ! eval "${cmd}" 1>/dev/null; then
        _error "Executing command (${cmd}) failed, please check it and try again."
    fi
}

_sleep_sec() {
    seconds=$1
    while [[ "${seconds}" -ge "0" ]]; do
      echo -ne "\r     \r"
      _green "${seconds}"
      seconds=$((seconds - 1))
      sleep 1
    done
    echo -ne "\r"
}

# Get OS ID from /etc/os-release
_get_os_id() {
    if [[ -f /etc/os-release ]]; then
        awk -F= '/^ID=/{gsub(/"/, ""); print $2}' /etc/os-release
    fi
}

# Check OS type
_check_sys() {
    local os_type="$1"
    local os_id
    os_id=$(_get_os_id)
    case "${os_type}" in
        rhel)
            [[ "${os_id}" =~ ^(centos|rhel|rocky|almalinux|ol|fedora)$ ]] || \
            [[ -f /etc/redhat-release ]]
            ;;
        debian)
            [[ "${os_id}" == "debian" ]]
            ;;
        ubuntu)
            [[ "${os_id}" == "ubuntu" ]]
            ;;
        *)
            return 1
            ;;
    esac
}

vhost() {
    case "$1" in
        [aA][dD][dD])
            add_vhost
            ;;
        [lL][iI][sS][tT])
            list_vhost
            ;;
        [dD][eE][lL])
            del_vhost
            ;;
        *)
            _error "Usage: lcmp vhost [add|list|del]"
            ;;
    esac
}

database() {
    case "$1" in
        [aA][dD][dD])
            add_database_menu
            add_database
            ;;
        [lL][iI][sS][tT])
            list_database
            ;;
        [dD][eE][lL])
            del_database
            ;;
        [eE][dD][iI][tT])
            edit_database
            ;;
        *)
            _error "Usage: lcmp db [add|list|del|edit]"
            ;;
    esac
}

add_vhost() {
    while true; do
        read -r -p "[$(date)] Please input a domain (example: www.lamp.sh): " domain
        if [[ -z "${domain}" ]]; then
            _red "Domain name can not be empty.\n"
            continue
        fi
        if [[ "${domain}" =~ [[:space:]] ]]; then
            _red "Domain name can not contain space.\n"
            continue
        fi
        if [[ ! "${domain}" =~ ^[a-zA-Z0-9][-a-zA-Z0-9.]*[a-zA-Z0-9]$ ]]; then
            _red "Domain name is invalid. Only letters, numbers, hyphen and dot are allowed.\n"
            continue
        fi
        if [[ -f "/etc/caddy/conf.d/${domain}.conf" ]]; then
            _red "Domain name ${domain} already exists, please check it and try again.\n"
            continue
        else
            _info "Domain name: $(_green "${domain}")"
            break
        fi
    done

    # Check if domain is a root domain (format: domain.tld, only one dot)
    redirect_www="n"
    if [[ "${domain}" != *.*.* ]] && [[ "${domain}" == *.* ]]; then
        www_domain="www.${domain}"
        if [[ ! -f "/etc/caddy/conf.d/${www_domain}.conf" ]]; then
            read -r -p "[$(date)] Redirect $(_green "${domain}") to $(_green "${www_domain}") (y/n, default: n): " redirect_www
            if [[ "${redirect_www}" == "y" ]] || [[ "${redirect_www}" == "Y" ]]; then
                redirect_www="y"
                _info "Will redirect $(_green "${domain}") to $(_green "${www_domain}")"
            fi
        fi
    fi

    while true; do
        read -r -p "[$(date)] Please input a directory for domain ${domain} (default directory: /data/www/${domain}): " vhostdir
        if [[ -z "${vhostdir}" ]]; then
            vhostdir="/data/www/${domain}"
            break
        fi
        if [[ "${vhostdir}" != "/"* ]]; then
            _red "Directory must be an absolute path (start with /).\n"
            continue
        fi
        if [[ "${vhostdir}" =~ [[:space:]] ]]; then
            _red "Directory can not contain whitespace characters.\n"
            continue
        fi
        if [[ "${vhostdir}" == *[:\;*?\"\<\>\|]* ]]; then
            _red "Directory contains invalid characters.\n"
            continue
        fi
        break
    done
    _info "Virtual Host directory: $(_green "${vhostdir}")"

    read -r -p "[$(date)] Create a MariaDB database and a user with same name (y/n): " create_database
    if [[ "${create_database}" == "y" ]] || [[ "${create_database}" == "Y" ]]; then
        verify_db_password
        add_database_menu
    fi
    _info "Create Virtual Host directory"
    _error_detect "mkdir -p ${vhostdir}"
    _info "Set permissions of Virtual Host directory"
    _error_detect "chmod -R 755 ${vhostdir}"
    _error_detect "chown -R caddy:caddy ${vhostdir}"
    add_vhost_config
    if [[ "${create_database}" == "y" ]] || [[ "${create_database}" == "Y" ]]; then
        add_database
    fi
    _error_detect "systemctl restart caddy"
    _info "Virtual Host information:"
    _info "Domain name: $(_green "${domain}")"
    if [[ "${redirect_www}" == "y" ]]; then
        _info "Redirect: $(_green "${domain}") -> $(_green "${www_domain}")"
    fi
    _info "Virtual Host directory: $(_green "${vhostdir}")"
    _info "Virtual Host config: $(_green "/etc/caddy/conf.d/${domain}.conf")"
    list_vhost
    if [[ "${create_database}" == "y" ]] || [[ "${create_database}" == "Y" ]]; then
        _info "Database username: ${database_name}"
        _info "Database userpassword: ${mysql_password}"
        _info "Database name: ${database_name}"
    fi
}

add_vhost_config() {
    if [[ "${redirect_www}" == "y" ]]; then
        cat >"/etc/caddy/conf.d/${domain}.conf" <<EOF
${domain}, ${www_domain} {
	header {
		Strict-Transport-Security "max-age=31536000; preload"
		X-Content-Type-Options nosniff
		X-Frame-Options SAMEORIGIN
	}
	@www host ${domain}
	redir @www https://${www_domain}{uri} permanent
	root * ${vhostdir}
	encode gzip zstd
	php_fastcgi ${php_sock}
	file_server {
		index index.html
	}
	log {
		output file /var/log/caddy/access_${domain}.log {
			roll_size 32mb
			roll_keep 3
			roll_keep_for 7d
		}
	}
}
EOF
    else
        cat >"/etc/caddy/conf.d/${domain}.conf" <<EOF
${domain} {
	header {
		Strict-Transport-Security "max-age=31536000; preload"
		X-Content-Type-Options nosniff
		X-Frame-Options SAMEORIGIN
	}
	root * ${vhostdir}
	encode gzip zstd
	php_fastcgi ${php_sock}
	file_server {
		index index.html
	}
	log {
		output file /var/log/caddy/access_${domain}.log {
			roll_size 32mb
			roll_keep 3
			roll_keep_for 7d
		}
	}
}
EOF
    fi
}

list_vhost() {
    _info "Caddy Virtual Host list:"
    local vhosts=()
    while IFS=' ' read -r line; do vhosts+=("${line}"); done < <(find /etc/caddy/conf.d/ -name "*.conf" -type f -printf "%f\n" | sed 's/.conf//g' | grep -v "default")
    if [[ "${#vhosts[@]}" -gt 0 ]]; then
        for i in "${vhosts[@]}"; do
            _info "  $(_green "${i}")"
        done
    else
        _info "Caddy Virtual Host not found. You can create a new Caddy Virtual Host with command: $(_green "lcmp vhost add")"
    fi
}

del_vhost() {
    local vhostdir
    list_vhost
    while true; do
        read -r -p "[$(date)] Please enter a domain you want to delete: " domain
        if [[ -z "${domain}" ]]; then
            _red "Domain name can not be empty.\n"
            continue
        fi
        if [[ "${domain}" =~ [[:space:]] ]]; then
            _red "Domain name can not contain space.\n"
            continue
        fi
        if [[ ! "${domain}" =~ ^[a-zA-Z0-9][-a-zA-Z0-9.]*[a-zA-Z0-9]$ ]]; then
            _red "Domain name is invalid. Only letters, numbers, hyphen and dot are allowed.\n"
            continue
        fi
        _info "Domain name: $(_green "${domain}")"
        break
    done
    if [[ -f "/etc/caddy/conf.d/${domain}.conf" ]]; then
        vhostdir=$(grep "root *" "/etc/caddy/conf.d/${domain}.conf" | awk '{print $3}')
        _error_detect "rm -f /etc/caddy/conf.d/${domain}.conf"
        _info "Domain $(_red "${domain}") has been deleted."
        if [[ -n "${vhostdir}" ]]; then
            _info "Website directory $(_red "${vhostdir}") will not be deleted for security reasons."
        else
            _info "Website directory will not be deleted for security reasons."
        fi
        _info "You need to manually delete the website files."
        systemctl restart caddy >/dev/null 2>&1
    else
        _error "Domain: ${domain} does not exist."
    fi
}

make_temp_mycnf() {
    cat >/tmp/.my.cnf<<EOF
[client]
user=root
password='$1'
EOF
    chmod 600 /tmp/.my.cnf
}

clean_temp_mycnf() {
    if [[ -s "/tmp/.my.cnf" ]]; then
        rm -f /tmp/.my.cnf
    fi
    if [[ -s "/tmp/.mysql.tmp" ]]; then
        rm -f /tmp/.mysql.tmp
    fi
}

do_query() {
    echo "$1" >/tmp/.mysql.tmp
    chmod 600 /tmp/.mysql.tmp
    /usr/bin/mariadb --defaults-file=/tmp/.my.cnf </tmp/.mysql.tmp
    return $?
}

verify_db_password() {
    status=1
    while [[ ${status} -eq 1 ]]; do
        read -s -r -p "[$(date)] Please input current root password of Database (password will not shown): " db_root_password
        echo
        if ! /usr/bin/mariadb -uroot -p"${db_root_password}" -e "exit" >/dev/null 2>&1; then
            _red "MariaDB root password is incorrect, Please check it and try again.\n"
        fi
        make_temp_mycnf "${db_root_password}"
        do_query "exit"
        status=$?
    done
}

enter_database_name() {
    while true; do
        read -r -p "[$(date)] Please input database name: " database_name
        if [[ -z "${database_name}" ]]; then
            _red "Database name can not be empty!\n"
        else
            break
        fi
    done
}

add_database_menu() {
    enter_database_name
    _info "You will create a MariaDB database and a user with same name: $(_green "${database_name}")"
    read -s -r -p "[$(date)] Please input password for MariaDB user ${database_name} (password will not shown): " mysql_password
    if [[ -z "${mysql_password}" ]]; then
        mysql_password="${database_name}"
    fi
    echo
    _info "MariaDB database $(_green "${database_name}")'s password: ${mysql_password}"
}

add_database() {
    cat >/tmp/.add_mysql.sql<<EOF
CREATE USER '${database_name}'@'localhost' IDENTIFIED BY '${mysql_password}';
CREATE USER '${database_name}'@'127.0.0.1' IDENTIFIED BY '${mysql_password}';
GRANT USAGE ON *.* TO '${database_name}'@'localhost' IDENTIFIED BY '${mysql_password}';
GRANT USAGE ON *.* TO '${database_name}'@'127.0.0.1' IDENTIFIED BY '${mysql_password}';
CREATE DATABASE IF NOT EXISTS \`${database_name}\`;
GRANT ALL PRIVILEGES ON \`${database_name}\`.* TO '${database_name}'@'localhost';
GRANT ALL PRIVILEGES ON \`${database_name}\`.* TO '${database_name}'@'127.0.0.1';
FLUSH PRIVILEGES;
EOF
    if /usr/bin/mariadb --defaults-file=/tmp/.my.cnf </tmp/.add_mysql.sql >/dev/null 2>&1; then
        _info "Add database $(_green "${database_name}") successfully."
    else
        _info "Add database $(_red "${database_name}") failed."
    fi
    rm -f /tmp/.add_mysql.sql
}

list_database() {
    if /usr/bin/mariadb --defaults-file=/tmp/.my.cnf -e "SHOW DATABASES;"; then
        _info "List all databases successfully."
    else
        _info "List all databases failed."
    fi
}

del_database() {
    list_database
    enter_database_name
    if [[ "${database_name}" == "information_schema" || "${database_name}" == "mysql" || "${database_name}" == "performance_schema" || "${database_name}" == "sys" ]]; then
        _error "MariaDB system database $(_red "${database_name}") cannot be deleted."
    fi
    _info "Your will delete a MariaDB database and a user with same name: ${database_name}"
    _info "Wait 10 seconds, Press ctrl+c to cancel ..."
    _sleep_sec 10
    cat >/tmp/.del.mysql.sql<<EOF
DROP USER '${database_name}'@'127.0.0.1';
DROP USER '${database_name}'@'localhost';
DROP DATABASE IF EXISTS \`${database_name}\`;
FLUSH PRIVILEGES;
EOF
    if /usr/bin/mariadb --defaults-file=/tmp/.my.cnf </tmp/.del.mysql.sql; then
        _info "Delete database $(_green "${database_name}") successfully."
    else
        _info "Delete database $(_red "${database_name}") failed."
    fi
    rm -f /tmp/.del.mysql.sql
}

edit_database() {
    while true; do
        read -r -p "[$(date)] Please input database username: " database_username
        if [[ -z "${database_username}" ]]; then
            _red "Database username can not be empty!\n"
        else
            break
        fi
    done
    while true; do
        read -s -r -p "[$(date)] Please input NEW password (password will not shown): " database_username_passwd
        if [[ -z "${database_username_passwd}" ]]; then
            _red "NEW password can not be empty!\n"
        else
            break
        fi
    done
    echo
    do_query "SET PASSWORD FOR '${database_username}'@'127.0.0.1' = PASSWORD('${database_username_passwd}');"
    RT1=$?
    do_query "SET PASSWORD FOR '${database_username}'@'localhost' = PASSWORD('${database_username_passwd}');"
    RT2=$?
    if [[ $((RT1 + RT2)) -eq 0 ]]; then
        _info "Edit user $(_green "${database_username}")'s password successfully."
    else
        _info "Edit user $(_red "${database_username}")'s password failed."
    fi
    do_query "FLUSH PRIVILEGES;"
}

lcmp_start() {
    _info "Starting LCMP..."
    _error_detect "systemctl start caddy"
    _error_detect "systemctl start mariadb"
    _error_detect "systemctl start ${php_fpm}"
    _info "Start LCMP completed"
}

lcmp_stop() {
    _info "Stopping LCMP..."
    _error_detect "systemctl stop caddy"
    _error_detect "systemctl stop mariadb"
    _error_detect "systemctl stop ${php_fpm}"
    _info "Stop LCMP completed"
}

lcmp_status() {
    _info "systemctl status caddy"
    systemctl --no-pager -l status caddy || true
    echo
    _info "systemctl status mariadb"
    systemctl --no-pager -l status mariadb || true
    echo
    _info "systemctl status ${php_fpm}"
    systemctl --no-pager -l status "${php_fpm}" || true
}

lcmp_version() {
    _info "$(_green "Caddy") version:"
    /usr/bin/caddy version
    echo
    _info "$(_green "MariaDB") version:"
    /usr/bin/mariadb --version
    echo
    _info "$(_green "PHP") version:"
    /usr/bin/php -v
}

check_env() {
    if _check_sys rhel; then
        php_sock="unix//run/php-fpm/www.sock"
        php_fpm="php-fpm"
    elif _check_sys debian || _check_sys ubuntu; then
        php_sock="unix//run/php/php-fpm.sock"
        php_ver="$(/usr/bin/php -v | head -n1 | awk '{print $2}' | cut -d. -f1-2)"
        php_fpm="php${php_ver}-fpm"
    else
        _error "Unsupported OS. Please use Enterprise Linux 8+, Debian 11+, or Ubuntu 20.04+"
    fi
}

main() {
    # Check root
    if [[ ${EUID} -ne 0 ]]; then
        _red "This script must be run as root!\n"
        exit 1
    fi
    arg1="${1:-}"
    arg2="${2:-}"

    _info "+-------------------------------------------+"
    _info "|    Manager for LCMP, Written by Teddysun  |"
    _info "+-------------------------------------------+"
    _info "|    $(_green "https://github.com/teddysun/lcmp")       |"
    _info "+-------------------------------------------+"

    check_env

    case "${arg1}" in
        start)
            lcmp_start
            ;;
        stop)
            lcmp_stop
            ;;
        restart)
            lcmp_stop
            sleep 1
            lcmp_start
            ;;
        status)
            lcmp_status
            ;;
        version)
            lcmp_version
            ;;
        vhost)
            vhost "${arg2}"
            ;;
        db)
            verify_db_password
            database "${arg2}"
            clean_temp_mycnf
            ;;
        *)
            _info "Usage:"
            _info "  $(_green "lcmp start")      Start all LCMP services"
            _info "  $(_green "lcmp stop")       Stop all LCMP services"
            _info "  $(_green "lcmp restart")    Restart all LCMP services"
            _info "  $(_green "lcmp status")     Check all LCMP services status"
            _info "  $(_green "lcmp version")    Print all of LCMP software version"
            _info "  $(_green "lcmp vhost add")  Create a new Caddy Virtual Host"
            _info "  $(_green "lcmp vhost list") List all of Caddy Virtual Hosts"
            _info "  $(_green "lcmp vhost del")  Delete a Caddy Virtual Host"
            _info "  $(_green "lcmp db add")     Create a MariaDB database and a user with same name"
            _info "  $(_green "lcmp db list")    List all of MariaDB databases"
            _info "  $(_green "lcmp db del")     Delete a MariaDB database and a user with same name"
            _info "  $(_green "lcmp db edit")    Update a MariaDB database username's password"
            ;;
    esac
}

# Run main function
main "$@"
